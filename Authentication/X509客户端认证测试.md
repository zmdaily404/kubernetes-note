# X509数字证书认证到API Server的测试
主要分为三步
1. 创建证书签署请求
2. 由Kubernetes CA签署证书
3. 用户使用证书认证到 API Server


### 创建由Kubernetes CA签署的证书（方式一）
创建证书签署请求
```bash
openssl genrsa -out ming.key 2048
openssl req -new -key ming.key -out ming.csr -subj "/CN=ming/O=developers"
```
获取用户crt的base64编码
```bash
cat ming.csr |base64 |tr -d '\n'
```
创建 CertificateSignRequest 资源
```bash
cat > certificatesignrequest-ming.yaml << EOF
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: ming
spec:
  request: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JS..."
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 864000  # ten days
  usages:
  - client auth
EOF
```
创建csr请求
```bash
kubectl apply -f certificatesignrequest-ming.yaml
```
查看csr请求
```bash
kubectl get csr
```

签署请求
```bash
kubectl certificate approve ming
```

保存为 ming.crt
```bash
kubectl get csr ming -o jsonpath={.status.certificate} |base64 -d > ming.crt
```
### 创建由Kubernetes CA签署的证书（方式二）



```bash
openssl x509 -req -days 10 -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -in ./ming.csr -out ./ming.crt
```

### 用户使用证书认证到 API Server
curl测试
```bash
# 提示 "message": "forbidden: User \"ming\" cannot get path \"/\"" 正常，表示用户已通过认证，只是还没有授权
curl -k -E ./ming.crt --key ./ming.key https://192.168.0.121:6443
```
kubectl测试（非master节点执行）
kubectl --client-certificate=./ming.crt --client-key=./ming.key --certificate-authority=/etc/kubernetes/pki/ca.crt --server https://192.168.0.121:6443 get node
```
