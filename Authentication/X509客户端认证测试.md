#3 X509数字证书认证到API Server的测试
创建证书签署请求
由Kubernetes CA签署证书
用户使用证书认证到 API Server


#3 创建由Kubernetes CA签署的证书
创建证书签署请求
```bash
openssl genrsa -out ming.key 2048
openssl req -new -key ming.key -out ming.csr -subj "/CN=ming/O=system:masters"
```
获取用户crt的base64编码
```bash
cat ming.crt |base64 |tr -d '\n'
```
创建 CertificateSignRequest 资源
```bash
cat > certificatesignrequest-ming.yaml << EOF
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: ming
spec:
  request: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ2FqQ0NBVklDQVFBd0pURU9NQXdHQTFVRUF3d0ZiV0Z6YjI0eEV6QVJCZ05WQkFvTUNtUmxkbVZzYjNCbApjbk13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLQW9JQkFRRFZSaVphbXppczg2NjRNdGtRCnVxb0RZR01uK0F0UFRXMTNNdzB4VzE2VFczaGVjQzJuNDhIekVqTktoRjRSVW9UMGJTQmZUWXNIZHBVTU5Uak4KcVZyQWlBT2gyT3hSMHRZS2dMbmFyUGh6dVE3aDJ2M2tKU1FpZ1Q5bGtHTEtDQzFwcERML0QrMTV0eG50bXpMaApxTUZ1U01DL3BTdUhQYTN1NzhvTldXSGpRVmN1M3d6UkhoRTFibWNMOVVvdWtiZGh1V0dIMlVtN211dmNwQUJXCjFDRDZGek1vQzFmdjNpam93OG0yaFUxNEVzZkFhaVBlU2J1VEtUMW9vUkJxd0J6UDRDV3MzVVd3cUhHcHB3cHMKVDhOeFY2RmZGYkQ2K3pxcFNMVy8rbHc5VHhDZWlrTmtUb1RnM0IwajBYSTlreWpvOFliOFdDMUpuTG5pNXZWVgo3K3pGQWdNQkFBR2dBREFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBSmFoTE41V00yemZNeWFxNGFKelNsS253CnlhL3MwZUcxR1JkbzdRUXVLcmNkcFdmRzk0b0xPNkcyKzZBakVzNXhZVSt2amVha0gxcjRVRUhiN3B2WDRWcy8KazhublVFV3hwUkIvQzdQZ3ZlMnBKd2pyZHhlMEJrVnM0aEd3TnByazhaK1FtdFhGUGNPOWJGUFN4aUhNdm12egoydkk0MVZ6eGV4YXZYWG5PWnJuT2w1YmlhWGNRSkZnUjhlY2VYcFJtZzVrM09NMzZITk9PdmV6dUw5WE94cG5lCnE0ZWZTdEU0ZFlYQlRtaGtMMUdjd1lPbzZxM0luN3BXL2FEMFBRbktqQWhkU2ExWmRHRVFzMS9OOFZDQXNJK3IKWGpxLzQzeElreEloNEliajErZjh4NmdyUS9Hbkt0MCsyWXF5K21NMW5Zc0NScTU3S3ZhRDBvQmVPc24vZXc9PQotLS0tLUVORCBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0K
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 864000  # ten days
  usages:
  - client auth
EOF
```
创建csr请求
```bash
kubectl apply -f certificatesignrequest-ming.yaml
```
openssl x509 -req -days 10 -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -in ./ming.csr -out ./ming.crt
```

#3 认证测试
```bash
# curl测试
curl -k -E ./ming.crt --key ./ming.key https://192.168.0.121:6443
# kubectl测试（非master节点执行）
kubectl --client-certificate=./ming.crt --client-key=./ming.key --certificate-authority=/etc/kubernetes/pki/ca.crt --server https://192.168.0.121:6443 get node
```
